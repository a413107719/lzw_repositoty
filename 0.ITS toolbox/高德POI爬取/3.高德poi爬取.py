# coding:utf-8
import requests
import math
import pymongo
import random
import time


def getpoi(single_coord, featuretype, key, pagenum):
    # global totalnum1
    """
    获取的数据格式如下:
    {'parent': [], 'address': '南坪新街与南坪正街交叉口西北100米', 'distance': [], 'biz_ext': {'cost': [], 'rating': [], 'ticket_ordering': '0'}, 'pname': '重庆市', 'importance': [], 'biz_type': 'tour',
    'cityname': '重庆市', 'type': '风景名胜;风景名胜相关;旅游景点', 'photos': [], 'typecode': '110000', 'shopinfo': '2', 'poiweight': [], 'childtype': [], 'adname': '南岸区', 'name': '长廊议事园',
    'location': '106.571085,29.539080', 'tel': [], 'shopid': [], 'id': 'B0FFH600HP'}
    """
    try:
        url= "https://restapi.amap.com/v3/place/polygon?polygon=" + single_coord + "&types=" + featuretype + "&offset=20" + "&extensions=all" + "&page=" + str(pagenum) + "&output=JSON" + "&key=" + key
        response = requests.get(url)
        answer = response.json()
        count = int(answer['count'])
        namelist = []
        if count < 950:
            pois = answer['pois']
            for dic in pois:
                name = dic['name']
                # print(dic['typecode'], name, dic)
                namelist.append(name)

                # 将子字典转为text
                for key in dic.keys():
                    value = dic[key]
                    if type(value) == dict or list:
                        dic[key] = str(value)
                # 写入mongodb
                mycolumn.update(dic, dic, True)

            print(' ', featuretype, 'countnum=%s'%(count), namelist)

            return count
        else:
            print('%s获取的POI数量超过预设值，将重新切分！' % (str(single_coord)))
            return single_coord
    except Exception as e:
        print('Wrong:', e)


def get_singlekindpoi(featuretype, polygoncoord, key):
    coordlist = [polygoncoord]
    while coordlist:
        # print('循环处理：', coordlist, '\n')
        willexposelist = []
        # 循环获取经纬度范围内的poi
        for coord in coordlist:
            # print('正在处理：' + coord)
            print('>>>', coord, featuretype, key)
            returnvalue = getpoi(coord, featuretype, key,  pagenum=1)
            if type(returnvalue) is int:
                if returnvalue != 0:
                    pagenum = int(math.ceil(returnvalue/20))
                    print("共有%d页数据"%(pagenum))
                    for page in range(2, pagenum + 1):
                        print('  开始爬第%d页' % (page))
                        getpoi(coord, featuretype, key, page)
            else:
                willexposelist.append(coord)

        # print()
        # print('willexposelist:', willexposelist)
        # 切分willexposelist中的要素
        coordlist =[]
        for exposevalue in willexposelist:
            A = float(exposevalue.split('|')[0].split(',')[0])  # coordinate1_lat
            B = float(exposevalue.split('|')[0].split(',')[1])  # coordinate1_lon
            C = float(exposevalue.split('|')[1].split(',')[0])  # coordinate2_lat
            D = float(exposevalue.split('|')[1].split(',')[1])  # coordinate2_lon
            e = round((A + C) / 2, 8)
            f = round((B + D) / 2, 8)
            coord1 = str(A) + ',' + str(B) + '|' + str(e) + ',' + str(f)
            coord2 = str(e) + ',' + str(f) + '|' + str(C) + ',' + str(D)
            coord3 = str(A) + ',' + str(f) + '|' + str(e) + ',' + str(D)
            coord4 = str(e) + ',' + str(B) + '|' + str(C) + ',' + str(f)
            coordlist += [coord1, coord2, coord3, coord4]
        # print('newcoordlist:', coordlist)

# feature = '190000'
# polygoncoord = '103.85074948100004,27.859987800125047|103.96316753600004,27.775174733250054'
# get_singlekindpoi(feature, polygoncoord, "5b6cc66ab2e8a5c0fb5ee4a2d7c0a564")


def get_gaode_poi(feature_types, polygon_coords, keys, table):
    global mycolumn

    # mongod参数
    client = pymongo.MongoClient('localhost', 27017)
    mydb = client['zkStudio']
    mycolumn = mydb[table]

    for feature_type in feature_types:
        for polygon_coord in polygon_coords:
            key = random.choice(keys)   # random select key
            print('\n', '--------------key:', key, '---------------')
            get_singlekindpoi(feature_type, polygon_coord, key)
            time.sleep(3)
        time.sleep(300)  # 每爬一类数据休息5分钟，不要爬过分了
    print('finish')


if __name__ == '__main__':
    # 设置参数
    gaodekeys = ["98e5a8a9f13d1edf592b5c33603f468b", 'c901a0e9831a87816cbbf1040de5028f', '183546d1af9d39827c7d59db79ab5c98', 'ced84567e83969d671a50b7264a0c58d', '14d4441635066afdd7a330e1c8107194']      # 高德keys
    tablename= 'xindu_gaodepoi20201010'      # mongod数据表名称
    # 类型、范围参数
    # types = ['010000', '020000', '030000', '040000', '050000', '060000', '070000', '080000', '090000', '100000', '110000', '120000', '130000', '140000', '150000', '160000', '170000', '180000', '190000', '200000', '220000', '970000', '990000']
    types = ['160000', '170000', '190000', '200000']
    # types = ['060000']     # 其它几个分类可以不爬['100000', '180000',  '220000', '970000', '990000']

    coords = ['103.90078684200006,30.963072307000054|103.95569960075005,30.933148195000054', '103.95569960075005,30.933148195000054|104.01061235950004,30.903224083000055', '103.95569960075005,30.963072307000054|104.01061235950004,30.933148195000054', '103.90078684200006,30.933148195000054|103.95569960075005,30.903224083000055', '104.01061235950004,30.903224083000055|104.06552511825004,30.87329997100006', '104.06552511825004,30.87329997100006|104.12043787700003,30.84337585900006', '104.06552511825004,30.903224083000055|104.12043787700003,30.87329997100006', '104.01061235950004,30.87329997100006|104.06552511825004,30.84337585900006', '104.01061235950004,30.963072307000054|104.06552511825004,30.933148195000054', '104.06552511825004,30.933148195000054|104.12043787700003,30.903224083000055', '104.06552511825004,30.963072307000054|104.12043787700003,30.933148195000054', '104.01061235950004,30.933148195000054|104.06552511825004,30.903224083000055', '103.90078684200006,30.903224083000055|103.95569960075005,30.87329997100006', '103.95569960075005,30.87329997100006|104.01061235950004,30.84337585900006', '103.95569960075005,30.903224083000055|104.01061235950004,30.87329997100006', '103.90078684200006,30.87329997100006|103.95569960075005,30.84337585900006', '104.21075067800003,30.963072307000054|104.24060200300003,30.933148195000054', '104.24060200300003,30.933148195000054|104.27045332800004,30.903224083000055', '104.24060200300003,30.963072307000054|104.27045332800004,30.933148195000054', '104.21075067800003,30.933148195000054|104.24060200300003,30.903224083000055', '104.27045332800004,30.903224083000055|104.30030465300005,30.87329997100006', '104.30030465300005,30.87329997100006|104.33015597800006,30.84337585900006', '104.30030465300005,30.903224083000055|104.33015597800006,30.87329997100006', '104.27045332800004,30.87329997100006|104.30030465300005,30.84337585900006', '104.27045332800004,30.963072307000054|104.30030465300005,30.933148195000054', '104.30030465300005,30.933148195000054|104.33015597800006,30.903224083000055', '104.30030465300005,30.963072307000054|104.33015597800006,30.933148195000054', '104.27045332800004,30.933148195000054|104.30030465300005,30.903224083000055', '104.21075067800003,30.903224083000055|104.24060200300003,30.87329997100006', '104.24060200300003,30.87329997100006|104.27045332800004,30.84337585900006', '104.24060200300003,30.903224083000055|104.27045332800004,30.87329997100006', '104.21075067800003,30.87329997100006|104.24060200300003,30.84337585900006', '104.21075067800003,30.75589890300006|104.24060200300003,30.736055880750058', '104.24060200300003,30.736055880750058|104.27045332800004,30.716212858500057', '104.24060200300003,30.75589890300006|104.27045332800004,30.736055880750058', '104.21075067800003,30.736055880750058|104.24060200300003,30.716212858500057', '104.27045332800004,30.716212858500057|104.30030465300005,30.696369836250057', '104.30030465300005,30.696369836250057|104.33015597800006,30.676526814000056', '104.30030465300005,30.716212858500057|104.33015597800006,30.696369836250057', '104.27045332800004,30.696369836250057|104.30030465300005,30.676526814000056', '104.27045332800004,30.75589890300006|104.30030465300005,30.736055880750058', '104.30030465300005,30.736055880750058|104.33015597800006,30.716212858500057', '104.30030465300005,30.75589890300006|104.33015597800006,30.736055880750058', '104.27045332800004,30.736055880750058|104.30030465300005,30.716212858500057', '104.21075067800003,30.716212858500057|104.24060200300003,30.696369836250057', '104.24060200300003,30.696369836250057|104.27045332800004,30.676526814000056', '104.24060200300003,30.716212858500057|104.27045332800004,30.696369836250057', '104.21075067800003,30.696369836250057|104.24060200300003,30.676526814000056', '104.12043787700003,30.84337585900006|104.14301607725002,30.821506620000058', '104.14301607725002,30.821506620000058|104.16559427750002,30.79963738100006', '104.14301607725002,30.84337585900006|104.16559427750002,30.821506620000058', '104.12043787700003,30.821506620000058|104.14301607725002,30.79963738100006', '104.16559427750002,30.79963738100006|104.18817247775002,30.77776814200006', '104.18817247775002,30.77776814200006|104.21075067800003,30.75589890300006', '104.18817247775002,30.79963738100006|104.21075067800003,30.77776814200006', '104.16559427750002,30.77776814200006|104.18817247775002,30.75589890300006', '104.16559427750002,30.84337585900006|104.18817247775002,30.821506620000058', '104.18817247775002,30.821506620000058|104.21075067800003,30.79963738100006', '104.18817247775002,30.84337585900006|104.21075067800003,30.821506620000058', '104.16559427750002,30.821506620000058|104.18817247775002,30.79963738100006', '104.12043787700003,30.79963738100006|104.14301607725002,30.77776814200006', '104.14301607725002,30.77776814200006|104.16559427750002,30.75589890300006', '104.14301607725002,30.79963738100006|104.16559427750002,30.77776814200006', '104.12043787700003,30.77776814200006|104.14301607725002,30.75589890300006', '104.01061235950004,30.75589890300006|104.03806873887504,30.736055880750058', '104.03806873887504,30.736055880750058|104.06552511825004,30.716212858500057', '104.03806873887504,30.75589890300006|104.06552511825004,30.736055880750058', '104.01061235950004,30.736055880750058|104.03806873887504,30.716212858500057', '104.06552511825004,30.716212858500057|104.09298149762503,30.696369836250057', '104.09298149762503,30.696369836250057|104.12043787700003,30.676526814000056', '104.09298149762503,30.716212858500057|104.12043787700003,30.696369836250057', '104.06552511825004,30.696369836250057|104.09298149762503,30.676526814000056', '104.06552511825004,30.75589890300006|104.09298149762503,30.736055880750058', '104.09298149762503,30.736055880750058|104.12043787700003,30.716212858500057', '104.09298149762503,30.75589890300006|104.12043787700003,30.736055880750058', '104.06552511825004,30.736055880750058|104.09298149762503,30.716212858500057', '104.01061235950004,30.716212858500057|104.03806873887504,30.696369836250057', '104.03806873887504,30.696369836250057|104.06552511825004,30.676526814000056', '104.03806873887504,30.716212858500057|104.06552511825004,30.696369836250057', '104.01061235950004,30.696369836250057|104.03806873887504,30.676526814000056', '104.12043787700003,30.963072307000054|104.14301607725002,30.933148195000054', '104.14301607725002,30.933148195000054|104.16559427750002,30.903224083000055', '104.14301607725002,30.963072307000054|104.16559427750002,30.933148195000054', '104.12043787700003,30.933148195000054|104.14301607725002,30.903224083000055', '104.16559427750002,30.903224083000055|104.18817247775002,30.87329997100006', '104.18817247775002,30.87329997100006|104.21075067800003,30.84337585900006', '104.18817247775002,30.903224083000055|104.21075067800003,30.87329997100006', '104.16559427750002,30.87329997100006|104.18817247775002,30.84337585900006', '104.16559427750002,30.963072307000054|104.18817247775002,30.933148195000054', '104.18817247775002,30.933148195000054|104.21075067800003,30.903224083000055', '104.18817247775002,30.963072307000054|104.21075067800003,30.933148195000054', '104.16559427750002,30.933148195000054|104.18817247775002,30.903224083000055', '104.12043787700003,30.903224083000055|104.14301607725002,30.87329997100006', '104.14301607725002,30.87329997100006|104.16559427750002,30.84337585900006', '104.14301607725002,30.903224083000055|104.16559427750002,30.87329997100006', '104.12043787700003,30.87329997100006|104.14301607725002,30.84337585900006', '104.12043787700003,30.75589890300006|104.14301607725002,30.736055880750058', '104.14301607725002,30.736055880750058|104.16559427750002,30.716212858500057', '104.14301607725002,30.75589890300006|104.16559427750002,30.736055880750058', '104.12043787700003,30.736055880750058|104.14301607725002,30.716212858500057', '104.16559427750002,30.716212858500057|104.18817247775002,30.696369836250057', '104.18817247775002,30.696369836250057|104.21075067800003,30.676526814000056', '104.18817247775002,30.716212858500057|104.21075067800003,30.696369836250057', '104.16559427750002,30.696369836250057|104.18817247775002,30.676526814000056', '104.16559427750002,30.75589890300006|104.18817247775002,30.736055880750058', '104.18817247775002,30.736055880750058|104.21075067800003,30.716212858500057', '104.18817247775002,30.75589890300006|104.21075067800003,30.736055880750058', '104.16559427750002,30.736055880750058|104.18817247775002,30.716212858500057', '104.12043787700003,30.716212858500057|104.14301607725002,30.696369836250057', '104.14301607725002,30.696369836250057|104.16559427750002,30.676526814000056', '104.14301607725002,30.716212858500057|104.16559427750002,30.696369836250057', '104.12043787700003,30.696369836250057|104.14301607725002,30.676526814000056', '103.90078684200006,30.75589890300006|103.92824322137506,30.736055880750058', '103.92824322137506,30.736055880750058|103.95569960075005,30.716212858500057', '103.92824322137506,30.75589890300006|103.95569960075005,30.736055880750058', '103.90078684200006,30.736055880750058|103.92824322137506,30.716212858500057', '103.95569960075005,30.716212858500057|103.98315598012505,30.696369836250057', '103.98315598012505,30.696369836250057|104.01061235950004,30.676526814000056', '103.98315598012505,30.716212858500057|104.01061235950004,30.696369836250057', '103.95569960075005,30.696369836250057|103.98315598012505,30.676526814000056', '103.95569960075005,30.75589890300006|103.98315598012505,30.736055880750058', '103.98315598012505,30.736055880750058|104.01061235950004,30.716212858500057', '103.98315598012505,30.75589890300006|104.01061235950004,30.736055880750058', '103.95569960075005,30.736055880750058|103.98315598012505,30.716212858500057', '103.90078684200006,30.716212858500057|103.92824322137506,30.696369836250057', '103.92824322137506,30.696369836250057|103.95569960075005,30.676526814000056', '103.92824322137506,30.716212858500057|103.95569960075005,30.696369836250057', '103.90078684200006,30.696369836250057|103.92824322137506,30.676526814000056', '104.21075067800003,30.84337585900006|104.24060200300003,30.821506620000058', '104.24060200300003,30.821506620000058|104.27045332800004,30.79963738100006', '104.24060200300003,30.84337585900006|104.27045332800004,30.821506620000058', '104.21075067800003,30.821506620000058|104.24060200300003,30.79963738100006', '104.27045332800004,30.79963738100006|104.30030465300005,30.77776814200006', '104.30030465300005,30.77776814200006|104.33015597800006,30.75589890300006', '104.30030465300005,30.79963738100006|104.33015597800006,30.77776814200006', '104.27045332800004,30.77776814200006|104.30030465300005,30.75589890300006', '104.27045332800004,30.84337585900006|104.30030465300005,30.821506620000058', '104.30030465300005,30.821506620000058|104.33015597800006,30.79963738100006', '104.30030465300005,30.84337585900006|104.33015597800006,30.821506620000058', '104.27045332800004,30.821506620000058|104.30030465300005,30.79963738100006', '104.21075067800003,30.79963738100006|104.24060200300003,30.77776814200006', '104.24060200300003,30.77776814200006|104.27045332800004,30.75589890300006', '104.24060200300003,30.79963738100006|104.27045332800004,30.77776814200006', '104.21075067800003,30.77776814200006|104.24060200300003,30.75589890300006', '104.01061235950004,30.84337585900006|104.03806873887504,30.821506620000058', '104.03806873887504,30.821506620000058|104.06552511825004,30.79963738100006', '104.03806873887504,30.84337585900006|104.06552511825004,30.821506620000058', '104.01061235950004,30.821506620000058|104.03806873887504,30.79963738100006', '104.06552511825004,30.79963738100006|104.09298149762503,30.77776814200006', '104.09298149762503,30.77776814200006|104.12043787700003,30.75589890300006', '104.09298149762503,30.79963738100006|104.12043787700003,30.77776814200006', '104.06552511825004,30.77776814200006|104.09298149762503,30.75589890300006', '104.06552511825004,30.84337585900006|104.09298149762503,30.821506620000058', '104.09298149762503,30.821506620000058|104.12043787700003,30.79963738100006', '104.09298149762503,30.84337585900006|104.12043787700003,30.821506620000058', '104.06552511825004,30.821506620000058|104.09298149762503,30.79963738100006', '104.01061235950004,30.79963738100006|104.03806873887504,30.77776814200006', '104.03806873887504,30.77776814200006|104.06552511825004,30.75589890300006', '104.03806873887504,30.79963738100006|104.06552511825004,30.77776814200006', '104.01061235950004,30.77776814200006|104.03806873887504,30.75589890300006', '103.90078684200006,30.84337585900006|103.92824322137506,30.821506620000058', '103.92824322137506,30.821506620000058|103.95569960075005,30.79963738100006', '103.92824322137506,30.84337585900006|103.95569960075005,30.821506620000058', '103.90078684200006,30.821506620000058|103.92824322137506,30.79963738100006', '103.95569960075005,30.79963738100006|103.98315598012505,30.77776814200006', '103.98315598012505,30.77776814200006|104.01061235950004,30.75589890300006', '103.98315598012505,30.79963738100006|104.01061235950004,30.77776814200006', '103.95569960075005,30.77776814200006|103.98315598012505,30.75589890300006', '103.95569960075005,30.84337585900006|103.98315598012505,30.821506620000058', '103.98315598012505,30.821506620000058|104.01061235950004,30.79963738100006', '103.98315598012505,30.84337585900006|104.01061235950004,30.821506620000058', '103.95569960075005,30.821506620000058|103.98315598012505,30.79963738100006', '103.90078684200006,30.79963738100006|103.92824322137506,30.77776814200006', '103.92824322137506,30.77776814200006|103.95569960075005,30.75589890300006', '103.92824322137506,30.79963738100006|103.95569960075005,30.77776814200006', '103.90078684200006,30.77776814200006|103.92824322137506,30.75589890300006']


    # 开始运行
    get_gaode_poi(types, coords, gaodekeys, tablename)

